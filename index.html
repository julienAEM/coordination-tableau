<!DOCTYPE html>

<!--
  Version du formulaire avec génération de PDF. Lors de l'envoi, un fichier
  PDF est produit avec l'ensemble des informations du rapport, y compris les
  statuts sélectionnés. Ce PDF est automatiquement téléchargé afin que
  l'utilisateur puisse l'imprimer ou l'ajouter en pièce jointe. Les adresses
  courriel sont définies via la page admin et utilisées pour composer le
  courriel, mais l'ajout automatique d'une pièce jointe n'est pas possible
  directement avec mailto.
-->
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Plan de match – Changement de quart</title>
<style>
  :root {
    --primary-color: #253746;
    --secondary-color: #324e67;
    --accent-color: #0078C8;
    --text-light: #ffffff;
    --field-bg: #f5f5f5;
    --section-bg-blue: #1f3a5f;
    --section-bg-orange: #a64d00;
    --section-bg-red: #a00000;
  }
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: var(--primary-color);
    color: var(--text-light);
  }
  .form-wrapper {
    max-width: 1000px;
    margin: 2rem auto;
    background: var(--secondary-color);
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    overflow: hidden;
  }
  .form-header {
    background: var(--primary-color);
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    border-bottom: 3px solid var(--accent-color);
  }
  .form-header img { height: 50px; margin-right: 1rem; }
  .form-header h1 { font-size: 1.5rem; color: var(--text-light); margin: 0; }
  .link-buttons { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
  .link-button { display: inline-block; padding: 0.7rem 1.4rem; background: var(--accent-color); color: var(--text-light); border-radius: 4px; text-decoration: none; font-size: 1rem; }
  .link-button:hover { background: #005fa0; }
  .form-content { padding: 2rem; }
  label { display: block; margin-top: 0.8rem; font-weight: bold; color: var(--text-light); }
  input[type="text"], textarea, select { width: 100%; padding: 0.6rem; margin-top: 0.2rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; box-sizing: border-box; background: var(--field-bg); color: #333; }
  textarea { resize: vertical; min-height: 60px; }
  .team-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
  .team-table th, .team-table td { border: 1px solid #ddd; padding: 0.4rem; text-align: left; }
  .team-table th { background: var(--section-bg-blue); color: var(--text-light); }

  @media print {
    button { display: none; }
    .link-buttons { display: none; }
  }

  .status-btn { padding: 0.4rem 0.8rem; border: none; border-radius: 4px; color: #fff; margin-right: 0.3rem; cursor: pointer; }
  .status-btn.arr { background-color: red; }
  .status-btn.func { background-color: green; }
  .status-btn.selected { box-shadow: 0 0 0 3px #fff inset; border: 2px solid #fff; }
  .status-btn.arr.selected { background-color: #ff6666; }
  .status-btn.func.selected { background-color: #66cc66; }
</style>
</head>
<body>
<div class="form-wrapper">
  <div class="form-header">
    <img alt="Logo AEM" src="https://aemhpa.com/hs-fs/hubfs/AEM%20Logo%20(with%20name%20in%20white%20right)%201.png?width=226&amp;height=64&amp;name=AEM%20Logo%20(with%20name%20in%20white%20right)%201.png"/>
    <h1>Plan de match – Changement de quart</h1>
  </div>
  <div class="link-buttons">
    <a class="link-button" href="admin.html">Admin</a>
    <a class="link-button" href="rapport_search.html">Consulter les rapports</a>
    <a class="link-button" href="supervisor_form.html">Rapport fin de rotation (superviseur)</a>
  </div>
  <div class="form-content">
    <h2>Superviseur</h2>
    <label for="superviseur">Superviseur :</label>
    <select id="superviseur" name="superviseur">
      <option value="">--Sélectionnez--</option>
      <option value="Vincent Lévesque">Vincent Lévesque</option>
      <option value="Olivier Chrétien">Olivier Chrétien</option>
    </select>
    <label for="quart">Quart :</label>
    <select id="quart" name="quart">
      <option value="">--Sélectionnez--</option>
      <option value="Jour">Jour</option>
      <option value="Nuit">Nuit</option>
    </select>
    <label for="date_du_jour">Date :</label>
    <input id="date_du_jour" name="date_du_jour" type="date"/>
    <form id="planForm">
      <!-- Section synthèse général -->
      <label for="evt_sst">Événement SST :</label>
      <textarea id="evt_sst" name="evt_sst"></textarea>
      <label for="evt_env">Événement environnement et MDR :</label>
      <textarea id="evt_env" name="evt_env"></textarea>
      <label for="travaux_mec">Travaux mécanique en cours :</label>
      <textarea id="travaux_mec" name="travaux_mec"></textarea>
      <label for="resume_jour">Superviseur/Opérateur (résumé de la journée/nuit) :</label>
      <textarea id="resume_jour" name="resume_jour"></textarea>
      <table class="team-table" id="categoryTable">
        <thead>
          <tr>
            <th>Catégorie</th>
            <th>Consigne</th>
            <th>Commentaires</th>
            <th>État</th>
          </tr>
        </thead>
        <tbody>
          <!-- Pour chaque catégorie, on ajoute une ligne -->
          <tr data-category="Digestion"><td>Digestion</td><td><textarea id="digestion_consigne" name="digestion_consigne"></textarea></td><td><textarea id="digestion_commentaire" name="digestion_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
          <tr data-category="Cristalisation"><td>Cristalisation</td><td><textarea id="cristalisation_consigne" name="cristalisation_consigne"></textarea></td><td><textarea id="cristalisation_commentaire" name="cristalisation_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
          <tr data-category="Centrifuge"><td>Centrifuge</td><td><textarea id="centrifuge_consigne" name="centrifuge_consigne"></textarea></td><td><textarea id="centrifuge_commentaire" name="centrifuge_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
          <tr data-category="Décomposition (Harpers)"><td>Décomposition (Harpers)</td><td><textarea id="decomposition_harpers_consigne" name="decomposition_harpers_consigne"></textarea></td><td><textarea id="decomposition_harpers_commentaire" name="decomposition_harpers_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
          <tr data-category="Calcination (F04)"><td>Calcination (F04)</td><td><textarea id="calcination_f04_consigne" name="calcination_f04_consigne"></textarea></td><td><textarea id="calcination_f04_commentaire" name="calcination_f04_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
          <tr data-category="Lavage S02"><td>Lavage S02</td><td><textarea id="lavage_s02_consigne" name="lavage_s02_consigne"></textarea></td><td><textarea id="lavage_s02_commentaire" name="lavage_s02_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
          <tr data-category="Buhler"><td>Buhler</td><td><textarea id="buhler_consigne" name="buhler_consigne"></textarea></td><td><textarea id="buhler_commentaire" name="buhler_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
          <tr data-category="HP60 (Mega Pulse)"><td>HP60 (Mega Pulse)</td><td><textarea id="hp60_mega_pulse_consigne" name="hp60_mega_pulse_consigne"></textarea></td><td><textarea id="hp60_mega_pulse_commentaire" name="hp60_mega_pulse_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
          <tr data-category="Mini-Pulse"><td>Mini-Pulse</td><td><textarea id="mini_pulse_consigne" name="mini_pulse_consigne"></textarea></td><td><textarea id="mini_pulse_commentaire" name="mini_pulse_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
          <tr data-category="Fabrication de Puck"><td>Fabrication de Puck</td><td><textarea id="fabrication_de_puck_consigne" name="fabrication_de_puck_consigne"></textarea></td><td><textarea id="fabrication_de_puck_commentaire" name="fabrication_de_puck_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
          <tr data-category="Traitement des eaux"><td>Traitement des eaux</td><td><textarea id="traitement_des_eaux_consigne" name="traitement_des_eaux_consigne"></textarea></td><td><textarea id="traitement_des_eaux_commentaire" name="traitement_des_eaux_commentaire"></textarea></td><td><button type="button" class="status-btn arr" onclick="toggleStatus(this)">Arrêt</button><button type="button" class="status-btn func" onclick="toggleStatus(this)">Fonction</button></td></tr>
        </tbody>
      </table>
      <button type="submit">Envoyer</button>
      <button type="button" onclick="window.print()">Imprimer</button>
    </form>
  </div>
</div>
<!-- Inclusion de la bibliothèque jsPDF depuis un CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
// Initialiser la date par défaut
document.addEventListener('DOMContentLoaded', function() {
  var dateInput = document.getElementById('date_du_jour');
  if (dateInput) {
    var today = new Date().toISOString().substr(0, 10);
    dateInput.value = today;
  }
});

// Sélection d'état pour chaque ligne
function toggleStatus(btn) {
  var row = btn.closest('tr');
  var buttons = row.querySelectorAll('.status-btn');
  buttons.forEach(function(b) { b.classList.remove('selected'); });
  btn.classList.add('selected');
}

// Générer un PDF à partir du rapport
function generatePdf(report) {
  // Attendre que jsPDF soit chargé
  var jsPDF = window.jspdf.jsPDF;
  var doc = new jsPDF();
  var y = 10;
  doc.setFontSize(14);
  doc.text('Plan de match – Changement de quart', 10, y);
  y += 8;
  doc.setFontSize(12);
  doc.text('Date: ' + report.date, 10, y); y += 6;
  doc.text('Superviseur: ' + report.superviseur, 10, y); y += 6;
  doc.text('Quart: ' + report.quart, 10, y); y += 8;
  doc.setFontSize(11);
  doc.text('Événement SST: ' + (report.evt_sst || ''), 10, y); y += 6;
  doc.text('Événement environnement et MDR: ' + (report.evt_env || ''), 10, y); y += 6;
  doc.text('Travaux mécanique en cours: ' + (report.travaux_mec || ''), 10, y); y += 6;
  doc.text('Résumé journée/nuit: ' + (report.resume_jour || ''), 10, y); y += 8;
  // Boucle des catégories
  report.categories.forEach(function(cat) {
    doc.setFont(undefined, 'bold');
    doc.text(cat.categorie, 10, y); y += 6;
    doc.setFont(undefined, 'normal');
    doc.text('Consigne: ' + (cat.consigne || ''), 12, y); y += 6;
    doc.text('Commentaires: ' + (cat.commentaire || ''), 12, y); y += 6;
    doc.text('État: ' + (cat.etat || ''), 12, y); y += 8;
    if (y > 280) { doc.addPage(); y = 10; }
  });
  var filename = 'rapport_' + report.date + '.pdf';
  doc.save(filename);
}

// Soumission du formulaire
document.addEventListener('DOMContentLoaded', function() {
  var form = document.getElementById('planForm');
  if (form) {
    form.addEventListener('submit', function(event) {
      event.preventDefault();
      // Collecte des informations
      var date = document.getElementById('date_du_jour').value;
      var superviseur = document.getElementById('superviseur').value;
      var quart = document.getElementById('quart').value;
      var evt_sst = document.getElementById('evt_sst').value;
      var evt_env = document.getElementById('evt_env').value;
      var travaux_mec = document.getElementById('travaux_mec').value;
      var resume_jour = document.getElementById('resume_jour').value;
      var report = {
        date: date,
        superviseur: superviseur,
        quart: quart,
        evt_sst: evt_sst,
        evt_env: evt_env,
        travaux_mec: travaux_mec,
        resume_jour: resume_jour,
        categories: []
      };
      var body = 'Superviseur: ' + superviseur + '\nQuart: ' + quart + '\nDate: ' + date + '\n\n';
      body += 'Événement SST: ' + evt_sst + '\n';
      body += 'Événement environnement et MDR: ' + evt_env + '\n';
      body += 'Travaux mécanique en cours: ' + travaux_mec + '\n';
      body += 'Résumé journée/nuit: ' + resume_jour + '\n\n';
      // Parcourir chaque ligne de catégorie
      var rows = document.querySelectorAll('#categoryTable tbody tr');
      rows.forEach(function(row) {
        var category = row.getAttribute('data-category');
        var consigne = row.querySelector('textarea[name$="_consigne"]').value;
        var commentaire = row.querySelector('textarea[name$="_commentaire"]').value;
        var selected = row.querySelector('.status-btn.selected');
        var etat = selected ? selected.textContent : '';
        report.categories.push({ categorie: category, consigne: consigne, commentaire: commentaire, etat: etat });
        body += category + '\nConsigne: ' + consigne + '\nCommentaires: ' + commentaire + '\nÉtat: ' + etat + '\n\n';
      });
      // Sauvegarde dans localStorage
      try {
        var existing = localStorage.getItem('rapports');
        var arr = existing ? JSON.parse(existing) : [];
        arr.push(report);
        localStorage.setItem('rapports', JSON.stringify(arr));
      } catch (e) {
        console.error('Erreur sauvegarde : ', e);
      }
      // Générer le PDF et proposer le téléchargement
      generatePdf(report);
      // Préparer l'envoi par courriel
      var emailListRaw = localStorage.getItem('emailList') || '';
      var emailArray = emailListRaw.split(/[;\n]+/).map(function(e) { return e.trim(); }).filter(function(e) { return e.length > 0; });
      var toField = emailArray.join(',');
      var subject = 'Plan de match - ' + date;
      var mailtoLink = 'mailto:' + encodeURIComponent(toField) + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body + '\n\nVeuillez trouver le rapport en pièce jointe.');
      window.location.href = mailtoLink;
      alert('Rapport enregistré, PDF généré et courriel préparé. Veuillez joindre le fichier PDF au courriel avant l’envoi définitif.');
    });
  }
});
</script>
</body>
</html>
